import{_ as Te,r,p as $,Q as Se,q as Ce,R as xe,c as v,o as c,d as a,e as l,w as o,i as p,aa as Ee,f as _,W as T,t as n,J as z,P as Z,I as Le,a3 as Ve,D as De,aw as Ie,E as k,ax as Ne,h as Pe,n as d,S as ee,U as te,O as Ue,z as Be,$ as Oe,B as $e,m as ze,g as We,a5 as le,j as Re}from"./index-BQoz9wsR.js";import{n as Ae}from"./index-mp-WL5tY.js";const Fe={class:"live-logs-page"},Ge={class:"page-header"},Je={class:"header-left"},Me={class:"header-info"},je={key:0},qe={class:"header-actions"},Ke={class:"filter-bar"},Qe={class:"stats-bar"},He={class:"stat-item"},Xe={class:"stat-value"},Ye={class:"stat-item"},Ze={class:"stat-value"},et={class:"stat-item"},tt={class:"stat-value"},lt={key:0,class:"empty-state"},at={key:0},st={key:1},ot=["onClick"],nt={class:"log-header"},it={class:"log-meta"},ut={class:"log-action"},ct={class:"log-time"},rt={class:"log-location"},dt={class:"log-content"},vt={class:"log-path"},pt={class:"log-info"},_t={key:0,class:"server-name"},ft={class:"client-ip"},mt=["title"],ht={key:0,class:"log-description"},yt={key:0,class:"log-detail"},gt={class:"path-code"},kt={class:"ip-value"},bt={class:"tk-value"},wt={class:"description-value"},Tt={key:0,class:"body-section"},St=10,ae=5e3,Ct=3e4,xt={__name:"LiveLogs",setup(Et){const se=Ce(),oe=Pe(),D=r(null),S=r(null),b=r([]),u=r(null),E=r(!1),C=r(!1),W=r(!0),R=r(null);let I=null,N=null;const L=r(0),V=r(!1),P=r(""),U=r(""),B=r(""),A=r(!1),i=r(null),ne=$(()=>{const e=new Set(b.value.map(t=>t.action).filter(Boolean));return Array.from(e)}),ie=$(()=>new Set(b.value.map(t=>t.tk).filter(Boolean)).size),M=$(()=>C.value?{type:"warning",text:"连接中..."}:E.value?{type:"success",text:"已连接"}:{type:"info",text:"未连接"}),F=$(()=>b.value.filter(e=>{if(P.value){const t=P.value.toLowerCase();if(![e.path,e.action,e.description,e.clientIp,e.tk,e.body].filter(Boolean).some(f=>f.toLowerCase().includes(t)))return!1}return!(U.value&&e.method!==U.value||B.value&&e.action!==B.value)})),ue=async()=>{try{const e=await Ae(D.value);e.statusCode===200&&e.data&&(S.value=e.data)}catch(e){console.error("获取站点信息失败:",e)}},ce=()=>{O(),I=setInterval(()=>{u.value&&u.value.readyState===WebSocket.OPEN&&u.value.send(JSON.stringify({action:"ping"}))},Ct)},O=()=>{I&&(clearInterval(I),I=null)},G=()=>{N&&(clearTimeout(N),N=null)},j=()=>{if(!V.value){if(L.value>=St){k.error("重连失败次数过多，请手动重新连接");return}G(),N=setTimeout(()=>{L.value++,J(!0)},ae)}},J=(e=!1)=>{var f;if(!((f=S.value)!=null&&f.domain)){k.warning("无法获取站点域名");return}u.value&&(u.value.close(),u.value=null),C.value=!0,V.value=!1;const x=`${window.location.protocol==="https:"?"wss:":"ws:"}//${S.value.domain}/wsLogs/${D.value}`;try{u.value=new WebSocket(x),u.value.onopen=()=>{E.value=!0,C.value=!1;const m=L.value;L.value=0,e?k.success(`重连成功 (尝试 ${m} 次)`):k.success("WebSocket 连接成功"),ce()},u.value.onmessage=m=>{try{const h=JSON.parse(m.data);if(h.action==="pong")return;Array.isArray(h)?h.forEach(y=>q(y)):q(h)}catch(h){console.error("解析日志数据失败:",h)}},u.value.onerror=m=>{console.error("WebSocket 错误:",m),C.value=!1},u.value.onclose=()=>{E.value=!1,C.value=!1,O(),V.value?k.info("WebSocket 连接已断开"):(k.warning(`连接断开，${ae/1e3}秒后自动重连...`),j())}}catch(m){console.error("创建 WebSocket 失败:",m),k.error("创建 WebSocket 连接失败"),C.value=!1,j()}},q=e=>{e._id=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,b.value.unshift(e),b.value.length>3e3&&b.value.pop(),W.value&&Ne(()=>{ve()})},re=()=>{V.value=!0,O(),G(),L.value=0,u.value&&(u.value.close(),u.value=null)},de=()=>{b.value=[]},ve=()=>{R.value&&(R.value.scrollTop=0)},pe=()=>{oe.push("/sites")},K=async e=>{try{await navigator.clipboard.writeText(e),k.success("已复制到剪贴板")}catch(t){console.error("复制失败:",t),k.error("复制失败")}},_e=e=>{i.value=e,A.value=!0},Q=e=>({GET:"success",POST:"primary",PUT:"warning",DELETE:"danger"})[e]||"info",fe=e=>({"log-get":e.method==="GET","log-post":e.method==="POST","log-put":e.method==="PUT","log-delete":e.method==="DELETE"}),me=e=>e?new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"}):"-",he=e=>e?new Date(e).toLocaleString("zh-CN"):"-",H=e=>{const t=[e.ipCountry,e.ipProvince,e.ipCity].filter(Boolean);return t.length>0?t.join(" · "):"未知位置"},ye=e=>{if(!e)return"";try{const t=JSON.parse(e);return JSON.stringify(t,null,2)}catch{return e}};return Se(async()=>{var e;D.value=se.params.id,D.value&&(await ue(),(e=S.value)!=null&&e.domain&&J())}),xe(()=>{V.value=!0,O(),G(),u.value&&(u.value.close(),u.value=null)}),(e,t)=>{const x=_("el-button"),f=_("el-tag"),m=_("el-switch"),h=_("el-input"),y=_("el-option"),X=_("el-select"),w=_("el-icon"),g=_("el-descriptions-item"),Y=_("el-tooltip"),ge=_("el-descriptions"),ke=_("el-dialog");return c(),v("div",Fe,[a("div",Ge,[a("div",Je,[l(x,{icon:p(Ee),text:"",onClick:pe},{default:o(()=>[...t[6]||(t[6]=[d("返回",-1)])]),_:1},8,["icon"]),a("div",Me,[t[7]||(t[7]=a("h3",null,"实时日志",-1)),S.value?(c(),v("p",je,n(S.value.name)+" - "+n(S.value.domain),1)):T("",!0)])]),a("div",qe,[l(f,{type:M.value.type,effect:"dark",size:"small"},{default:o(()=>[t[8]||(t[8]=a("span",{class:"status-dot"},null,-1)),d(" "+n(M.value.text),1)]),_:1},8,["type"]),E.value?(c(),z(x,{key:1,type:"danger",icon:p(Le),onClick:re},{default:o(()=>[...t[10]||(t[10]=[d(" 断开 ",-1)])]),_:1},8,["icon"])):(c(),z(x,{key:0,type:"primary",icon:p(Z),onClick:J,loading:C.value},{default:o(()=>[...t[9]||(t[9]=[d(" 连接 ",-1)])]),_:1},8,["icon","loading"])),l(x,{icon:p(Ve),onClick:de},{default:o(()=>[...t[11]||(t[11]=[d("清空日志",-1)])]),_:1},8,["icon"]),l(m,{modelValue:W.value,"onUpdate:modelValue":t[0]||(t[0]=s=>W.value=s),"active-text":"自动滚动","inactive-text":"",style:{"margin-left":"12px"}},null,8,["modelValue"])])]),a("div",Ke,[l(h,{modelValue:P.value,"onUpdate:modelValue":t[1]||(t[1]=s=>P.value=s),placeholder:"搜索日志内容...","prefix-icon":p(De),clearable:"",class:"search-input"},null,8,["modelValue","prefix-icon"]),l(X,{modelValue:U.value,"onUpdate:modelValue":t[2]||(t[2]=s=>U.value=s),placeholder:"请求方法",clearable:""},{default:o(()=>[l(y,{label:"全部",value:""}),l(y,{label:"GET",value:"GET"}),l(y,{label:"POST",value:"POST"}),l(y,{label:"PUT",value:"PUT"}),l(y,{label:"DELETE",value:"DELETE"})]),_:1},8,["modelValue"]),l(X,{modelValue:B.value,"onUpdate:modelValue":t[3]||(t[3]=s=>B.value=s),placeholder:"事件类型",clearable:""},{default:o(()=>[l(y,{label:"全部",value:""}),(c(!0),v(ee,null,te(ne.value,s=>(c(),z(y,{key:s,label:s,value:s},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),a("div",Qe,[a("div",He,[t[12]||(t[12]=a("span",{class:"stat-label"},"总日志数",-1)),a("span",Xe,n(b.value.length),1)]),a("div",Ye,[t[13]||(t[13]=a("span",{class:"stat-label"},"已筛选",-1)),a("span",Ze,n(F.value.length),1)]),a("div",et,[t[14]||(t[14]=a("span",{class:"stat-label"},"唯一用户",-1)),a("span",tt,n(ie.value),1)])]),a("div",{class:"logs-container",ref_key:"logsContainer",ref:R},[F.value.length===0?(c(),v("div",lt,[l(w,{size:64},{default:o(()=>[l(p(Ue))]),_:1}),E.value?(c(),v("p",st,"等待日志数据...")):(c(),v("p",at,'点击"连接"按钮开始接收实时日志'))])):T("",!0),l(Ie,{name:"log-item",tag:"div",class:"logs-list"},{default:o(()=>[(c(!0),v(ee,null,te(F.value,(s,be)=>(c(),v("div",{key:s._id||be,class:Be(["log-item",fe(s)]),onClick:we=>_e(s)},[a("div",nt,[a("div",it,[l(f,{type:Q(s.method),size:"small",effect:"plain",class:"method-tag"},{default:o(()=>[d(n(s.method),1)]),_:2},1032,["type"]),a("span",ut,n(s.action),1),a("span",ct,n(me(s.addTime)),1)]),a("div",rt,[l(w,null,{default:o(()=>[l(p(Oe))]),_:1}),a("span",null,n(H(s)),1)])]),a("div",dt,[a("div",vt,[l(w,null,{default:o(()=>[l(p($e))]),_:1}),a("span",null,n(s.path),1)]),a("div",pt,[s.serverName?(c(),v("span",_t,[l(w,null,{default:o(()=>[l(p(Z))]),_:1}),d(" "+n(s.serverName),1)])):T("",!0),a("span",ft,[l(w,null,{default:o(()=>[l(p(ze))]),_:1}),d(" "+n(s.clientIp)+" ",1),l(w,{class:"copy-btn",onClick:We(we=>K(s.clientIp),["stop"])},{default:o(()=>[l(p(le))]),_:1},8,["onClick"])]),s.tk?(c(),v("span",{key:1,class:"user-tk",title:s.tk},[l(w,null,{default:o(()=>[l(p(Re))]),_:1}),d(" "+n(s.tk),1)],8,mt)):T("",!0)])]),s.description?(c(),v("div",ht,n(s.description),1)):T("",!0)],10,ot))),128))]),_:1})],512),l(ke,{modelValue:A.value,"onUpdate:modelValue":t[5]||(t[5]=s=>A.value=s),title:"日志详情",width:"700px","destroy-on-close":"","align-center":"",class:"log-detail-dialog"},{default:o(()=>[i.value?(c(),v("div",yt,[l(ge,{column:2,border:""},{default:o(()=>[l(g,{label:"事件名称"},{default:o(()=>[l(f,{size:"small"},{default:o(()=>[d(n(i.value.action),1)]),_:1})]),_:1}),l(g,{label:"请求方法"},{default:o(()=>[l(f,{type:Q(i.value.method),size:"small"},{default:o(()=>[d(n(i.value.method),1)]),_:1},8,["type"])]),_:1}),l(g,{label:"请求路径",span:2},{default:o(()=>[l(Y,{content:i.value.path,placement:"top","show-after":300},{default:o(()=>[a("code",gt,n(i.value.path),1)]),_:1},8,["content"])]),_:1}),l(g,{label:"客户端 IP"},{default:o(()=>[a("span",kt,[d(n(i.value.clientIp)+" ",1),l(w,{class:"copy-btn",onClick:t[4]||(t[4]=s=>K(i.value.clientIp))},{default:o(()=>[l(p(le))]),_:1})])]),_:1}),l(g,{label:"用户标识"},{default:o(()=>[l(Y,{content:i.value.tk,placement:"top"},{default:o(()=>[a("span",bt,n(i.value.tk),1)]),_:1},8,["content"])]),_:1}),l(g,{label:"地理位置",span:2},{default:o(()=>[d(n(H(i.value)),1)]),_:1}),l(g,{label:"请求域名"},{default:o(()=>[d(n(i.value.serverName),1)]),_:1}),l(g,{label:"记录时间"},{default:o(()=>[d(n(he(i.value.addTime)),1)]),_:1}),i.value.description?(c(),z(g,{key:0,label:"描述信息",span:2,class:"description-item"},{default:o(()=>[a("span",wt,n(i.value.description),1)]),_:1})):T("",!0)]),_:1}),i.value.body?(c(),v("div",Tt,[t[15]||(t[15]=a("h4",null,"请求数据",-1)),l(h,{type:"textarea","model-value":ye(i.value.body),rows:8,readonly:"",class:"body-textarea"},null,8,["model-value"])])):T("",!0)])):T("",!0)]),_:1},8,["modelValue"])])}}},Dt=Te(xt,[["__scopeId","data-v-2d53f470"]]);export{Dt as default};
